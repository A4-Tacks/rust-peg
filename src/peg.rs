#![recursion_limit = "192"]

#[macro_use]
extern crate quote;

use std::env;
use std::fs::File;
use std::io::{Read, Write};
use std::io::{stdin, stdout, stderr};
use std::path::Path;
use std::process;
use translate::{compile_grammar};

mod translate;
mod grammar;

fn main() {
	let args = env::args_os().collect::<Vec<_>>();
	let progname = &args[0];

	let mut source = String::new();

	if args.len() == 2 && &args[1] != "-h" {
		let fname = Path::new(&args[1]);
		File::open(fname).unwrap().read_to_string(&mut source).unwrap();
	} else if args.len() == 1 {
		stdin().read_to_string(&mut source).unwrap();
	} else {
		println!("Usage: {} [file]", progname.to_string_lossy());
	}

	let grammar_def = grammar::grammar(&source);

	match grammar_def {
		Ok(grammar) => {
				let tokens = compile_grammar(&grammar);
				let mut out = stdout();

				writeln!(&mut out, "// Generated by rust-peg. Do not edit.").unwrap();
				writeln!(&mut out, "#![allow(non_snake_case, unused)]").unwrap();
				write!(&mut out, "{}", tokens).unwrap();
		}

		Err(msg) => {
			let mut e = stderr();
			(writeln!(&mut e, "Error parsing language specification: {}", msg)).unwrap();
			process::exit(1);
		}
	}
}
